<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>Queue Ticket System 叫號系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      body {
        background-color: #f4f6f9;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      /* 擬真票卡設計 */
      .ticket-card {
        border: none;
        border-radius: 16px;
        overflow: hidden;
        background: #fff;
        position: relative;
        transition: transform 0.2s;
      }
      .ticket-header {
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        color: white;
        padding: 1.5rem;
        text-align: center;
      }
      .ticket-divider {
        border-top: 2px dashed #e9ecef;
        margin: 1.5rem 0;
        position: relative;
      }
      .ticket-divider::before,
      .ticket-divider::after {
        content: "";
        position: absolute;
        top: -10px;
        width: 20px;
        height: 20px;
        background-color: #f4f6f9;
        border-radius: 50%;
      }
      .ticket-divider::before {
        left: -25px;
      }
      .ticket-divider::after {
        right: -25px;
      }

      .big-number {
        font-size: 3.5rem;
        font-weight: 800;
        letter-spacing: -1px;
        line-height: 1;
      }
      .info-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #6c757d;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fa-solid fa-ticket me-2"></i>Queue System
        </a>
        <div class="ms-auto">
          <a
            href="/admin/login"
            class="btn btn-outline-light btn-sm rounded-pill px-3"
          >
            <i class="fa-solid fa-user-gear me-1"></i>管理員
          </a>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
          <div class="card ticket-card shadow-lg">
            <div class="ticket-header">
              <h5 class="mb-0">即時叫號資訊</h5>
              <small class="opacity-75">Live Queue Status</small>
            </div>

            <div class="card-body text-center pt-4">
              <div>
                <div class="info-label mb-1">目前叫號 Current Number</div>
                <div id="current-number" class="display-4 fw-bold text-primary">
                  -
                </div>
              </div>

              <div class="ticket-divider"></div>

              <div id="user-info-area">
                <div class="info-label mb-1">您的號碼 My Number</div>
                <div id="my-number" class="big-number text-dark">-</div>

                <div class="mt-3">
                  <span
                    id="status-badge"
                    class="badge rounded-pill bg-light text-dark border px-3 py-2"
                  >
                    尚未取號
                  </span>
                </div>

                <div class="mt-3 text-muted small">
                  前面還有
                  <strong id="ahead-count" class="text-dark fs-6">-</strong>
                  人等待中
                </div>

                <div
                  id="qrcode-container"
                  class="mt-4 d-flex justify-content-center"
                  style="display: none !important"
                >
                  <div id="qrcode"></div>
                </div>
                <div
                  id="qrcode-hint"
                  class="small text-muted mt-2"
                  style="display: none"
                >
                  憑此碼報到 Check-in with QR
                </div>

                <div
                  id="counter-area"
                  class="alert alert-success mt-3 mx-2"
                  style="display: none"
                >
                  <div class="fw-bold">
                    <i class="fa-solid fa-bell me-2"></i>請前往櫃台
                  </div>
                  <div id="counter-name" class="fs-4 fw-bold"></div>
                </div>
              </div>

              <div class="mt-4 px-2 d-grid gap-2">
                <button
                  id="btn-take"
                  class="btn btn-primary btn-lg rounded-pill shadow-sm"
                >
                  <i class="fa-solid fa-hand-point-up me-2"></i>我要抽號
                </button>

                <button
                  id="btn-cancel"
                  class="btn btn-outline-danger btn-sm rounded-pill"
                  disabled
                >
                  取消排隊
                </button>
              </div>

              <div class="mt-3 small text-muted text-center">
                <i class="fa-solid fa-mobile-screen me-1"></i>手機掃描即可帶著走
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
      let currentTicketId = null;
      let currentService = null;
      let sseSource = null;
      let qrCodeObj = null;

      // ------------------------------------------
      // 1. UI 更新邏輯
      // ------------------------------------------
      function setNoTicketUI() {
        document.getElementById("my-number").textContent = "-";
        document.getElementById("ahead-count").textContent = "-";

        const statusBadge = document.getElementById("status-badge");
        statusBadge.textContent = "尚未取號";
        statusBadge.className =
          "badge rounded-pill bg-light text-dark border px-3 py-2";

        const btnTake = document.getElementById("btn-take");
        btnTake.disabled = false;
        btnTake.innerHTML =
          '<i class="fa-solid fa-hand-point-up me-2"></i>我要抽號';

        const btnCancel = document.getElementById("btn-cancel");
        btnCancel.disabled = true;
        btnCancel.style.display = "none";

        document
          .getElementById("qrcode-container")
          .style.setProperty("display", "none", "important");
        document.getElementById("qrcode-hint").style.display = "none";
        document.getElementById("counter-area").style.display = "none";
        document.getElementById("qrcode").innerHTML = "";
        qrCodeObj = null;

        currentTicketId = null;
        currentService = null;
        // SSE 不在此關閉，保持監聽大廳叫號
      }

      function generateQRCode(text) {
        const container = document.getElementById("qrcode");
        if (container.innerHTML.trim() !== "") return;

        document.getElementById("qrcode-container").style.display = "flex";
        document.getElementById("qrcode-hint").style.display = "block";

        qrCodeObj = new QRCode(container, {
          text: text,
          width: 128,
          height: 128,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });
      }

      function applyStatusToUI(data) {
        const currentNum = data.current_number ?? 0;
        const myNum = data.number;

        document.getElementById("current-number").textContent =
          data.current_number ?? "尚未開始";
        document.getElementById("my-number").textContent = myNum;
        document.getElementById("ahead-count").textContent = data.ahead_count;

        const ticketUrl = `${window.location.origin}/ticket/${data.ticket_id}/view`;
        generateQRCode(ticketUrl);

        let displayStatus = data.status;
        // 如果目前叫號已經等於或超過我的號碼，且我是 serving，那就是正在服務我
        if (data.status === "serving" && currentNum > myNum) {
          displayStatus = "done"; // 過號
        }

        const statusBadge = document.getElementById("status-badge");
        const counterArea = document.getElementById("counter-area");
        const counterName = document.getElementById("counter-name");
        const btnTake = document.getElementById("btn-take");
        const btnCancel = document.getElementById("btn-cancel");

        if (displayStatus === "waiting") {
          statusBadge.textContent = "排隊中 Waiting";
          statusBadge.className =
            "badge rounded-pill bg-warning text-dark px-3 py-2";
          btnTake.disabled = true;
          btnTake.textContent = "已在隊伍中";
          btnCancel.disabled = false;
          btnCancel.style.display = "inline-block";
          counterArea.style.display = "none";
        } else if (displayStatus === "serving") {
          statusBadge.textContent = "服務中 Serving";
          statusBadge.className =
            "badge rounded-pill bg-success px-3 py-2 animate__animated animate__pulse";
          counterArea.style.display = "block";
          counterName.textContent = data.counter || "櫃台";
          btnTake.disabled = true;
          btnTake.textContent = "正在服務您";
          btnCancel.style.display = "none";
        } else {
          statusBadge.textContent = "已過號 / 已取消";
          statusBadge.className = "badge rounded-pill bg-secondary px-3 py-2";
          btnTake.disabled = false;
          btnTake.innerHTML =
            '<i class="fa-solid fa-rotate-right me-2"></i> 重新抽號';
          btnCancel.style.display = "none";
        }
      }

      async function refreshStatus() {
        // 沒票就只更新標題 (但這裡不做，因為 setupSSE 已經在做標題更新)
        if (!currentTicketId) return;

        try {
          const res = await fetch(`/ticket/${currentTicketId}/status`);
          if (!res.ok) {
            setNoTicketUI();
            setupSSE("register");
            return;
          }
          const data = await res.json();
          applyStatusToUI(data);
        } catch (err) {
          console.error(err);
        }
      }

      // ------------------------------------------
      // 2. SSE 連線
      // ------------------------------------------
      function setupSSE(service) {
        if (
          sseSource &&
          sseSource.url.includes(service) &&
          sseSource.readyState !== EventSource.CLOSED
        ) {
          return;
        }
        if (sseSource) sseSource.close();

        sseSource = new EventSource(`/events/${service}`);

        sseSource.onmessage = function (event) {
          const msg = JSON.parse(event.data);
          if (msg.number) {
            document.getElementById("current-number").textContent = msg.number;
          }
          if (currentTicketId) {
            refreshStatus();
          }
        };

        let retryCount = 0;
        sseSource.onerror = function (err) {
          sseSource.close();
          let timeout = Math.min(1000 * Math.pow(2, retryCount), 10000);
          retryCount++;
          setTimeout(() => setupSSE(service), timeout);
        };
        sseSource.onopen = function () {
          retryCount = 0;
        };
      }

      // ------------------------------------------
      // 3. 初始與事件
      // ------------------------------------------
      async function init() {
        try {
          const res = await fetch("/session/status");
          const data = await res.json();
          if (data.has_ticket) {
            currentTicketId = data.ticket_id;
            currentService = data.service;
            await refreshStatus();
            setupSSE(currentService);
          } else {
            setNoTicketUI();
            setupSSE("register");
          }
        } catch (err) {
          setNoTicketUI();
          setupSSE("register");
        }
      }

      document
        .getElementById("btn-take")
        .addEventListener("click", async () => {
          const btn = document.getElementById("btn-take");
          btn.disabled = true;
          btn.innerHTML =
            '<span class="spinner-border spinner-border-sm"></span> 處理中...';

          try {
            if (currentTicketId) {
              await fetch("/session/clear", { method: "POST" });
              currentTicketId = null;
              document.getElementById("qrcode").innerHTML = "";
            }

            const res = await fetch("/session/ticket", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ service: "register" }),
            });

            if (res.ok || res.status === 400) {
              const data = await res.json();
              currentTicketId = data.ticket_id;
              currentService = data.service || "register";
              setupSSE(currentService);
              await refreshStatus();
            } else {
              alert("取號失敗");
              if (!currentTicketId) {
                setNoTicketUI();
                setupSSE("register");
              }
            }
          } catch (e) {
            console.error(e);
            alert("連線錯誤");
            if (!currentTicketId) btn.disabled = false;
          }
        });

      document
        .getElementById("btn-cancel")
        .addEventListener("click", async () => {
          if (!confirm("確定要放棄排隊嗎？")) return;
          await fetch("/session/cancel", { method: "POST" });
          setNoTicketUI();
          setupSSE("register");
        });

      init();

      // ★★★ [新增] 雙重保險：每 5 秒自動查詢一次最新狀態 ★★★
      // 這樣即使 SSE 斷線，最慢 5 秒後畫面也會自動更新！
      setInterval(() => {
        refreshStatus();
      }, 5000);
    </script>
  </body>
</html>
