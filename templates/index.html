<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>Queue System</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --serving-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --text-main: #2d3748;
        --text-muted: #718096;
      }

      body {
        background-color: var(--bg-color);
        font-family: "Noto Sans TC", sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Navbar */
      .navbar {
        background: var(--card-bg);
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem;
      }

      /* [修改] 品牌連結樣式 */
      .brand-text {
        font-weight: 700;
        font-size: 1.25rem;
        background: var(--primary-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-decoration: none; /* 移除連結底線 */
        display: flex;
        align-items: center;
      }

      /* 避免連結 hover 時變色或出現底線 */
      .brand-text:hover {
        text-decoration: none;
        opacity: 0.9;
      }

      main {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
      }

      /* Queue Card */
      .queue-card {
        border: none;
        border-radius: 24px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05),
          0 8px 10px -6px rgba(0, 0, 0, 0.01);
        overflow: hidden;
        background: var(--card-bg);
        transition: transform 0.2s ease;
        width: 100%;
      }

      .card-header-custom {
        background: var(--primary-gradient);
        padding: 2.5rem 1.5rem;
        text-align: center;
        color: white;
      }

      .current-number-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        opacity: 0.9;
        margin-bottom: 0.5rem;
      }

      .current-number {
        font-size: 4.5rem;
        font-weight: 900;
        line-height: 1;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .serving-mode .card-header-custom {
        background: var(--serving-gradient);
      }
      .serving-mode .current-number {
        animation: pulse 2s infinite;
      }

      /* Ticket Info Area */
      .ticket-section {
        padding: 2rem;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .info-item {
        background: #f7fafc;
        padding: 1.2rem 1rem;
        border-radius: 16px;
        text-align: center;
      }
      .info-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
      }
      .info-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-main);
      }

      /* Status Badge */
      .status-pill {
        display: inline-block;
        padding: 0.6rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 2rem;
      }

      /* Buttons */
      .btn-action {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 16px;
        border: none;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      .btn-primary-custom {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.4);
      }
      .btn-primary-custom:active {
        transform: scale(0.98);
      }
      .btn-outline-custom {
        background: transparent;
        border: 2px solid #e2e8f0;
        color: var(--text-muted);
        margin-top: 1rem;
      }

      /* QR Code */
      #qrcode-container {
        background: white;
        padding: 1rem;
        border-radius: 16px;
        border: 2px dashed #e2e8f0;
        width: fit-content;
        margin: 0 auto 1rem auto;
      }

      /* Footer */
      .site-footer {
        text-align: center;
        padding: 1.5rem;
        color: #a0aec0;
        font-size: 0.85rem;
        background-color: var(--bg-color);
        margin-top: auto;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar sticky-top">
      <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand brand-text" href="/"> Queue System </a>
        <a
          href="/admin/login"
          class="btn btn-sm btn-light rounded-pill px-3 fw-bold text-muted border"
        >
          <i class="fa-solid fa-lock me-1"></i> 管理員
        </a>
      </div>
    </nav>

    <main class="container">
      <div class="col-12 col-md-8 col-lg-4">
        <div id="main-card" class="queue-card">
          <div class="card-header-custom">
            <div class="current-number-label">目前叫號 CURRENT NUMBER</div>
            <div id="current-number" class="current-number">-</div>
          </div>

          <div class="ticket-section text-center">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">我的號碼</div>
                <div id="my-number" class="info-value">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">前面等待</div>
                <div class="info-value">
                  <span id="ahead-count">-</span
                  ><span class="fs-6 ms-1 text-muted">人</span>
                </div>
              </div>
            </div>

            <div id="status-badge" class="status-pill bg-light text-muted">
              尚未取號
            </div>

            <div
              id="counter-area"
              class="alert alert-success border-0 rounded-4 mb-4 hidden"
            >
              <div class="fw-bold fs-5">
                <i class="fa-solid fa-location-dot me-2"></i
                ><span id="counter-name"></span>
              </div>
              <div class="small">請前往上述櫃台辦理</div>
            </div>

            <div id="qrcode-wrapper" class="hidden">
              <div id="qrcode-container"><div id="qrcode"></div></div>
              <div class="small text-muted mb-4">請出示此碼報到</div>
            </div>

            <button id="btn-take" class="btn-action btn-primary-custom">
              <i class="fa-solid fa-plus"></i> 我要抽號
            </button>

            <button
              id="btn-cancel"
              class="btn-action btn-outline-custom hidden"
            >
              取消排隊
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer class="site-footer">&copy; 2024 Queue Ticket System</footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
      let currentTicketId = null;
      let currentService = null;
      let sseSource = null;
      let qrCodeObj = null;

      const dom = {
        card: document.getElementById("main-card"),
        currentNum: document.getElementById("current-number"),
        myNum: document.getElementById("my-number"),
        aheadCount: document.getElementById("ahead-count"),
        statusBadge: document.getElementById("status-badge"),
        btnTake: document.getElementById("btn-take"),
        btnCancel: document.getElementById("btn-cancel"),
        qrWrapper: document.getElementById("qrcode-wrapper"),
        qrBox: document.getElementById("qrcode"),
        counterArea: document.getElementById("counter-area"),
        counterName: document.getElementById("counter-name"),
      };

      function setNoTicketUI() {
        dom.card.classList.remove("serving-mode");
        dom.myNum.textContent = "-";
        dom.aheadCount.textContent = "-";

        dom.statusBadge.textContent = "尚未取號";
        dom.statusBadge.className = "status-pill bg-light text-muted";

        dom.btnTake.disabled = false;
        dom.btnTake.innerHTML = '<i class="fa-solid fa-plus"></i> 我要抽號';
        dom.btnTake.className = "btn-action btn-primary-custom";

        dom.btnCancel.classList.add("hidden");
        dom.qrWrapper.classList.add("hidden");
        dom.counterArea.classList.add("hidden");

        dom.qrBox.innerHTML = "";
        qrCodeObj = null;
        currentTicketId = null;
        currentService = null;
      }

      function generateQRCode(text) {
        if (dom.qrBox.innerHTML.trim() !== "") return;
        dom.qrWrapper.classList.remove("hidden");
        qrCodeObj = new QRCode(dom.qrBox, {
          text: text,
          width: 128,
          height: 128,
          colorDark: "#1f2937",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });
      }

      function applyStatusToUI(data) {
        const currentNum = data.current_number ?? 0;
        const myNum = data.number;

        dom.currentNum.textContent = data.current_number ?? "尚未開始";
        dom.myNum.textContent = myNum;
        dom.aheadCount.textContent = data.ahead_count;

        const ticketUrl = `${window.location.origin}/ticket/${data.ticket_id}/view`;
        generateQRCode(ticketUrl);

        let displayStatus = data.status;
        if (data.status === "serving" && currentNum > myNum) {
          displayStatus = "done";
        }

        dom.card.classList.remove("serving-mode");
        dom.counterArea.classList.add("hidden");
        dom.btnCancel.classList.add("hidden");

        if (displayStatus === "waiting") {
          dom.statusBadge.textContent = "排隊中 Waiting";
          dom.statusBadge.className = "status-pill bg-warning text-dark";

          dom.btnTake.disabled = true;
          dom.btnTake.innerHTML =
            '<i class="fa-solid fa-clock"></i> 已在隊伍中';
          dom.btnTake.className = "btn-action btn-light text-muted";

          dom.btnCancel.classList.remove("hidden");
        } else if (displayStatus === "serving") {
          dom.card.classList.add("serving-mode");

          dom.statusBadge.textContent = "服務中 Serving";
          dom.statusBadge.className =
            "status-pill bg-success text-white shadow";

          dom.counterArea.classList.remove("hidden");
          dom.counterName.textContent = data.counter || "櫃台";

          dom.btnTake.disabled = true;
          dom.btnTake.innerHTML = "正在服務您";
          dom.btnTake.className = "btn-action btn-success";
        } else {
          dom.statusBadge.textContent = "已過號 / 已取消";
          dom.statusBadge.className = "status-pill bg-secondary text-white";

          dom.btnTake.disabled = false;
          dom.btnTake.innerHTML =
            '<i class="fa-solid fa-rotate-right"></i> 重新抽號';
          dom.btnTake.className = "btn-action btn-primary-custom";
        }
      }

      async function refreshStatus() {
        if (!currentTicketId) return;
        try {
          const res = await fetch(`/ticket/${currentTicketId}/status`);
          if (!res.ok) {
            setNoTicketUI();
            setupSSE("register");
            return;
          }
          const data = await res.json();
          applyStatusToUI(data);
        } catch (err) {
          console.error(err);
        }
      }

      function setupSSE(service) {
        if (
          sseSource &&
          sseSource.url.includes(service) &&
          sseSource.readyState !== EventSource.CLOSED
        )
          return;
        if (sseSource) sseSource.close();

        sseSource = new EventSource(`/events/${service}`);
        sseSource.onmessage = function (event) {
          const msg = JSON.parse(event.data);
          if (msg.number) dom.currentNum.textContent = msg.number;
          if (currentTicketId) refreshStatus();
        };
        let retryCount = 0;
        sseSource.onerror = function (err) {
          sseSource.close();
          let timeout = Math.min(1000 * Math.pow(2, retryCount), 10000);
          retryCount++;
          setTimeout(() => setupSSE(service), timeout);
        };
        sseSource.onopen = function () {
          retryCount = 0;
        };
      }

      async function init() {
        try {
          const res = await fetch("/session/status");
          const data = await res.json();
          if (data.has_ticket) {
            currentTicketId = data.ticket_id;
            currentService = data.service;
            await refreshStatus();
            setupSSE(currentService);
          } else {
            setNoTicketUI();
            setupSSE("register");
          }
        } catch (err) {
          setNoTicketUI();
          setupSSE("register");
        }
      }

      dom.btnTake.addEventListener("click", async () => {
        dom.btnTake.disabled = true;
        dom.btnTake.innerHTML =
          '<i class="fa-solid fa-spinner fa-spin"></i> 處理中...';
        try {
          if (currentTicketId) {
            await fetch("/session/clear", { method: "POST" });
            currentTicketId = null;
            dom.qrBox.innerHTML = "";
          }
          const res = await fetch("/session/ticket", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ service: "register" }),
          });
          if (res.ok || res.status === 400) {
            const data = await res.json();
            currentTicketId = data.ticket_id;
            currentService = data.service || "register";
            setupSSE(currentService);
            await refreshStatus();
          } else {
            alert("取號失敗");
            if (!currentTicketId) {
              setNoTicketUI();
              setupSSE("register");
            }
          }
        } catch (e) {
          console.error(e);
          alert("連線錯誤");
          if (!currentTicketId) {
            dom.btnTake.disabled = false;
            dom.btnTake.innerHTML = '<i class="fa-solid fa-plus"></i> 我要抽號';
          }
        }
      });

      dom.btnCancel.addEventListener("click", async () => {
        if (!confirm("確定要放棄排隊嗎？")) return;
        await fetch("/session/cancel", { method: "POST" });
        setNoTicketUI();
        setupSSE("register");
      });

      init();
      setInterval(() => {
        refreshStatus();
      }, 5000);
    </script>
  </body>
</html>
