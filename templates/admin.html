<script>
  // 核心 API 連結
  const API_CALL_NEXT = "/counter/register/next";
  const API_SUMMARY = "/admin/api/summary";
  const API_DEMAND = "/admin/api/demand";

  // 錯誤顯示輔助
  function displayError(elementId, message) {
    const el = document.getElementById(elementId);
    if (!el.classList.contains("alert-danger")) {
      el.className = "alert alert-danger p-2 small mt-2";
    }
    el.textContent = message;
    el.style.display = "block";
  }

  function hideError(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.style.display = "none";
  }

  // --- 1. 數據載入 ---
  async function loadSummaryData() {
    try {
      const summaryRes = await fetch(API_SUMMARY);

      if (!summaryRes.ok) {
        // 如果伺服器返回 500，我們無法解析 JSON，因此拋出一個錯誤
        throw new Error(
          "Server returned HTTP " +
            summaryRes.status +
            " (Data likely not JSON)"
        );
      }

      const summaryData = await summaryRes.json();

      // 容錯處理：如果後端回傳了 error 旗標 (表示 RediSearch 失敗)
      if (summaryData.error) {
        // 顯示 RediSearch 錯誤訊息，但嘗試顯示其他可用數據
        displayError("live-error", "RediSearch 失敗，請檢查索引。");

        document.getElementById("live-waiting").textContent = "N/A";
        document.getElementById("live-serving").textContent = "N/A";
      } else {
        hideError("live-error");
        // RediSearch 依賴的數據
        document.getElementById("live-waiting").textContent =
          summaryData.live_waiting;
        document.getElementById("live-serving").textContent =
          summaryData.live_serving;
      }

      // 總體數據 (這些數據依賴簡單的 Hash/Counter，應該永遠可用)
      document.getElementById("total-issued").textContent =
        summaryData.total_issued;
      document.getElementById("total-served-today").textContent =
        summaryData.total_served_today;

      // Avg wait time formatting
      const avgTime = summaryData.avg_wait_time_today;
      document.getElementById("avg-wait-time-today").textContent =
        avgTime !== 0 && avgTime !== "N/A"
          ? avgTime.toFixed(1) + " 秒"
          : "-- 秒";

      document.getElementById("live-stats-time").textContent =
        new Date().toLocaleTimeString();
    } catch (e) {
      // 捕捉網路錯誤、500錯誤(非JSON)
      console.error("Failed to load summary data (CRASH):", e);
      displayError(
        "live-error",
        "嚴重連線錯誤，後端服務中斷。請檢查 Render Log。"
      );
      // 將 RediSearch 相關欄位清空
      document.getElementById("live-waiting").textContent = "--";
      document.getElementById("live-serving").textContent = "--";

      // 確保簡單數據不顯示錯誤
      document.getElementById("total-issued").textContent = "--";
      document.getElementById("total-served-today").textContent = "--";
    }
  }

  async function loadHourlyDemand() {
    const tbody = document.getElementById("hourly-demand-body");
    tbody.innerHTML =
      '<tr><td colspan="2" class="text-center text-muted">載入中...</td></tr>';

    try {
      const demandRes = await fetch(API_DEMAND);

      if (!demandRes.ok) {
        throw new Error("Server returned HTTP " + demandRes.status);
      }

      const demandData = await demandRes.json();

      if (demandData.error || demandData.length === 0) {
        displayError(
          "demand-error",
          demandData.error || "無抽號數據，請確保 RediSearch 啟用。"
        );
        tbody.innerHTML = `<tr><td colspan="2" class="text-center text-muted">無可用數據</td></tr>`;
        return;
      }

      hideError("demand-error");

      demandData.forEach((item) => {
        const tr = document.createElement("tr");
        const hourLabel = item.hour.toString().padStart(2, "0") + ":00";
        tr.innerHTML = `<td>${hourLabel}</td><td>${item.count} 人</td>`;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error("Failed to load hourly demand:", e);
      displayError(
        "demand-error",
        "網絡連線或數據載入失敗 (" + e.message + ")"
      );
      tbody.innerHTML = `<tr><td colspan="2" class="text-center text-danger">載入失敗</td></tr>`;
    }
  }

  // --- 2. 控制台事件 ---
  document
    .getElementById("btn-call-next")
    .addEventListener("click", async () => {
      const service = document.getElementById("service-select").value;
      const counter =
        document.getElementById("counter-input").value.trim() || "counter-1";
      const pre = document.getElementById("last-call-result");

      try {
        pre.textContent = "呼叫中...";
        const res = await fetch(API_CALL_NEXT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ counter: counter, service: service }),
        });

        if (!res.ok) {
          throw new Error(
            "HTTP " + res.status + ". Check Server Log for details."
          );
        }

        const data = await res.json();

        if (data.message === "no one in queue") {
          pre.textContent = `目前 ${service} 沒有人在排隊。`;
        } else {
          pre.textContent =
            `叫到號碼：${data.number}\n` +
            `ticket_id：${data.ticket_id}\n` +
            `櫃台 counter：${data.counter}\n` +
            `叫號時間 (Unix)：${data.called_at}`;
        }
      } catch (err) {
        console.error("叫號失敗:", err);
        pre.textContent = "叫號時發生嚴重錯誤，請檢查伺服器連線。";
      }

      loadSummaryData();
      loadHourlyDemand();
    });

  // --- 3. 初始化與自動刷新 ---
  function initializeDashboard() {
    loadSummaryData();
    loadHourlyDemand();
    setInterval(loadSummaryData, 5000);
    setInterval(loadHourlyDemand, 30000);
  }

  // 啟動儀表板
  initializeDashboard();
</script>
